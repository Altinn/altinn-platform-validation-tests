import { check, group } from "k6";
import http from "k6/http";
import { Trend } from "k6/metrics";
import { vu } from "k6/execution";
import { uuidv4, EnterpriseTokenGenerator, PersonalTokenGenerator, randomItem } from "../../../../common-imports.js";
import { SystemUserRequestApiClient, SystemRegisterApiClient } from "../../../../clients/auth/index.js";
import { CreateSystemUserRequest, ApproveSystemUserRequest } from "../../../building-blocks/auth/system-user-request/index.js";
import { CreateNewSystem } from "../../../building-blocks/auth/system-register/index.js";
import { parseCsvData } from "../../../../helpers.js";

const randomize = (__ENV.RANDOMIZE ?? "false") === "true";

const lessThan1000 = new Trend("less_than_1000");
const between1000And5000 = new Trend("between_1000_and_5000");
const between5000And10000 = new Trend("between_5000_and_10000");
const between10000And15000 = new Trend("between_10000_and_15000");
const between15000And20000 = new Trend("between_15000_and_20000");
const between20000And25000 = new Trend("between_20000_and_25000");
const moreThan25000 = new Trend("more_than_25000");

export const options = {
  summaryTrendStats: ['avg', 'min', 'med', 'max', 'p(95)', 'p(99)', 'count'],
};

export function setup() {
    const res = http.get(`https://raw.githubusercontent.com/Altinn/altinn-platform-validation-tests/refs/heads/create-approve-systemuser-revisited/K6/testdata/auth/data-${__ENV.ENVIRONMENT}-many-customers.csv`);
    return parseCsvData(res.body);
}

export default function (data) {

  const systemOwner = "713431400";

  let testCustomer = undefined;
  if (randomize) {
    testCustomer = randomItem(data);
  } else {
    testCustomer = data[__ITER % data.length];
  }

  const customers = testCustomer.customers;

  const options = new Map();
  options.set("env", __ENV.ENVIRONMENT);
  options.set("ttl", 3600);
  options.set("scopes", "altinn:authentication/systemregister.write altinn:authentication/systemuser.request.write altinn:authentication/systemuser.request.read altinn:authorization/authorize");
  options.set("orgNo", systemOwner);

  const tokenGenerator
      = new EnterpriseTokenGenerator(options);

  const systemRegisterApiClient
      = new SystemRegisterApiClient(__ENV.BASE_URL, tokenGenerator);

  const vendorSystemUserRequestApiClient
      = new SystemUserRequestApiClient(__ENV.BASE_URL, tokenGenerator);

  const resource = "ttd-dialogporten-performance-test-01";
  const name = `perftest${uuidv4()}`;
  const systemId = `${systemOwner}_${name}`;
  const clientId = uuidv4();
  const description = {
      "en": "This is auto generated by an integration test. Some data is randomized, but some is not - like this description",
      "nb": "Integrasjonstest. Noe er randomisert her, men mye blir likt.",
      "nn": "integrasjonstest pÃ¥ nynorsk. Noe er randomisert her, men mye blir likt."
  };
  const rights = [
      {
          "resource": [
              {
                  "value": resource,
                  "id": "urn:altinn:resource"
              }
          ]
      }
  ];

  const allowedRedirectUrls = ["https://digdir.no"];

  let res = CreateNewSystem(systemRegisterApiClient,
      systemOwner,
      name,
      clientId,
      description,
      rights,
      allowedRedirectUrls,
      []);
  check(res, {
      "CreateNewSystem - Creating a new System returns an ID": (r) => {
          const jsonBody = JSON.parse(r);
          const re = /^[a-z\d\-]+$/;
          return re.test(jsonBody);
      }
  });

  group("Create and Confirm System User Request", function () {
      let res = CreateSystemUserRequest(
          vendorSystemUserRequestApiClient,
          systemId,
          testCustomer.orgNo,//partyOrgNo,
          rights,
          allowedRedirectUrls[vu.idInTest - 1],
          []
      );
      check(res, {
          "CreateSystemUserRequest - Creating a new SystemUserRequest returns expected object": (r) => {
              const jsonBody = JSON.parse(r);
              return "id" in jsonBody &&
                  "externalRef" in jsonBody &&
                  "systemId" in jsonBody &&
                  "partyOrgNo" in jsonBody &&
                  "rights" in jsonBody &&
                  "status" in jsonBody &&
                  "redirectUrl" in jsonBody &&
                  "confirmUrl" in jsonBody;
          }
      });

      const requestId = JSON.parse(res).id;

      const options = new Map();
      options.set("env", __ENV.ENVIRONMENT);
      options.set("ttl", 3600);
      options.set("scopes", "altinn:portal/enduser");
      options.set("userId", testCustomer.userId);

      const tokenGenerator
          = new PersonalTokenGenerator(options);

      const approverSystemUserRequestApiClient
          = new SystemUserRequestApiClient(__ENV.BASE_URL, tokenGenerator);

      res = ApproveSystemUserRequest(approverSystemUserRequestApiClient,
          testCustomer.partyId,
          requestId);
      putInCorrectMetric(customers, res.timings.duration);
      check(res.body, {
          "ApproveSystemUserRequest - Approving the system user request is successful": (r) => {
              const jsonBody = JSON.parse(r);
              return true == jsonBody;
          }
      });
  });
}

function putInCorrectMetric(customers, duration) {
  if (customers < 1000) {
    lessThan1000.add(duration);
  } else if (customers >= 1000 && customers < 5000) {
    between1000And5000.add(duration);
  } else if (customers >= 5000 && customers < 10000) {
    between5000And10000.add(duration);
  } else if (customers >= 10000 && customers < 15000) {
    between10000And15000.add(duration);
  } else if (customers >= 15000 && customers < 20000) {
    between15000And20000.add(duration);
  } else if (customers >= 20000 && customers < 25000) {
    between20000And25000.add(duration);
  } else {
    moreThan25000.add(duration);
  }
}



