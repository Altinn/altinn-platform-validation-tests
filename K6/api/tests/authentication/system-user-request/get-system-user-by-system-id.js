import { check, group } from "k6";
import http from "k6/http";
import { vu } from "k6/execution";
import { uuidv4, EnterpriseTokenGenerator, PersonalTokenGenerator } from "../../../../common-imports.js";
import { SystemUserRequestApiClient, SystemRegisterApiClient } from "../../../../clients/authentication/index.js";
import {
    CreateSystemUserRequest,
    ApproveSystemUserRequest,
    GetSystemUserRequestsBySystemId,
    GetSystemUserRequestsByUrl,
} from "../../../building-blocks/authentication/system-user-request/index.js";
import { CreateNewSystem } from "../../../building-blocks/authentication/system-register/index.js";

export function setup() {
    // do something? maybe
}

function getVendorTokenGenerator(systemOwnerOrgNo) {
    const options = new Map();
    options.set("env", __ENV.ENVIRONMENT);
    options.set("ttl", 3600);
    options.set(
        "scopes",
        "altinn:authentication/systemregister.write altinn:authentication/systemuser.request.write altinn:authentication/systemuser.request.read"
    );
    options.set("orgNo", systemOwnerOrgNo);
    return new EnterpriseTokenGenerator(options);
}

function getApproverTokenGenerator(userId) {
    const options = new Map();
    options.set("env", __ENV.ENVIRONMENT);
    options.set("ttl", 3600);
    options.set("scopes", "altinn:portal/enduser");
    options.set("userId", userId);
    return new PersonalTokenGenerator(options);
}

function followNextLinks(systemUserRequestApiClient, firstPageBody, expectedBaseUrl, maxPages = 20) {
    let current = firstPageBody;
    let pages = 1;

    while (current && current.links && current.links.next && pages < maxPages) {
        const nextUrl = current.links.next;
        check(nextUrl, {
            "GetSystemUserRequestsBySystemId - links.next starts with https://": (u) =>
                typeof u === "string" && u.startsWith("https://"),
            "GetSystemUserRequestsBySystemId - links.next has correct base url": (u) =>
                typeof u === "string" && u.startsWith(expectedBaseUrl),
        });

        current = GetSystemUserRequestsByUrl(systemUserRequestApiClient, nextUrl);
        pages++;
    }

    return pages;
}

export default function (data) {
    const systemOwnerOrgNo = __ENV.SYSTEM_OWNER_ORGNO ?? "312605031";

    const vendorTokenGenerator = getVendorTokenGenerator(systemOwnerOrgNo);
    const systemRegisterApiClient = new SystemRegisterApiClient(__ENV.BASE_URL, vendorTokenGenerator);
    const vendorSystemUserRequestApiClient = new SystemUserRequestApiClient(__ENV.BASE_URL, vendorTokenGenerator);

    const seededSystemId = __ENV.SEEDED_SYSTEM_ID;
    const expectedNextBaseUrl = `${__ENV.BASE_URL}/authentication/api/v1/systemuser/request/vendor/bysystem/`;

    if (seededSystemId) {
        group("Get System User Requests By SystemId (seeded + pagination)", function () {
            const resBody = GetSystemUserRequestsBySystemId(vendorSystemUserRequestApiClient, seededSystemId);
            check(resBody, {
                "GetSystemUserRequestsBySystemId - has data array": (b) => b && Array.isArray(b.data),
            });

            followNextLinks(vendorSystemUserRequestApiClient, resBody, expectedNextBaseUrl);
        });
        return;
    }

    const customer = data[vu.idInTest - 1];

    // Step 1: Post System to System Register
    const resource = "ttd-dialogporten-performance-test-01";
    const name = `perftest${uuidv4()}`;
    const systemId = `${systemOwnerOrgNo}_${name}`;
    const clientId = uuidv4();
    const description = {
        en: "Auto generated by a validation test",
        nb: "Autogenerert av valideringstest",
        nn: "Autogenerert av valideringstest",
    };
    const rights = [
        {
            resource: [
                {
                    value: resource,
                    id: "urn:altinn:resource",
                },
            ],
        },
    ];
    const allowedRedirectUrls = ["https://digdir.no"];

    let res = CreateNewSystem(
        systemRegisterApiClient,
        systemOwnerOrgNo,
        name,
        clientId,
        description,
        rights,
        allowedRedirectUrls,
        []
    );

    check(res, {
        "CreateNewSystem - Creating a new System returns an ID": (r) => {
            const jsonBody = JSON.parse(r);
            const re = /^[a-z\d\-]+$/;
            return re.test(jsonBody);
        },
    });

    const resBody = GetSystemUserRequestsBySystemId(vendorSystemUserRequestApiClient, systemId);
    check(resBody, {
        "GetSystemUserRequestsBySystemId - data has at least 1 item": (b) => b && Array.isArray(b.data) && b.data.length >= 1,
        "GetSystemUserRequestsBySystemId - items include systemId": (b) =>
            b &&
            Array.isArray(b.data) &&
            b.data.every((x) => x && typeof x.systemId === "string"),
    });

    // Step 5: Follow next-link if present
    followNextLinks(vendorSystemUserRequestApiClient, resBody, expectedNextBaseUrl);
}

